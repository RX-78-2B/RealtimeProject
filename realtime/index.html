<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Realtime Project</title>
        <!-- Babylon.js -->
        <script src="hand.minified-1.2.js"></script>
        <script src="http://www.babylonjs.com/cannon.js"></script>
        <script src="http://www.babylonjs.com/oimo.js"></script>
		<script src="babylon.js"></script>
		<script id="vertexShader" type="x-shader/x-vertex">
			#ifdef GL_ES
			precision mediump float;
			#endif
			 
			// Attributes
			attribute vec3 position;
			attribute vec3 normal;
			attribute vec2 uv;
			 
			// Uniforms
			uniform vec2 waveData;
			uniform mat4 windMatrix;
			uniform mat4 world;
			uniform mat4 worldViewProjection;
			 
			// Normal
			varying vec3 vPositionW;
			varying vec3 vNormalW;
			varying vec4 vUV;
			varying vec2 vBumpUV;
			 
			void main(void) {
				vec4 outPosition = worldViewProjection * vec4(position, 1.0);
				gl_Position = outPosition;
			 
				vPositionW = vec3(world * vec4(position, 1.0));
				vNormalW = normalize(vec3(world * vec4(normal, 0.0)));
			 
				vUV = outPosition;
			 
				vec2 bumpTexCoord = vec2(windMatrix * vec4(uv, 0.0, 1.0));
				vBumpUV = bumpTexCoord / waveData.x;
			}

		</script>
		<script id="fragmentShader" type="x-shader/x-vertex">
		#ifdef GL_ES
		precision mediump float;
		#endif
		uniform vec3 vEyePosition;
		uniform vec4 vLevels;
		uniform vec3 waterColor;
		uniform vec2 waveData;	 
		// Lights
		varying vec3 vPositionW;
		varying vec3 vNormalW;
		uniform vec3 vLightPosition;		 
		// Refs
		varying vec2 vBumpUV;
		varying vec4 vUV;
		uniform sampler2D refractionSampler;
		uniform sampler2D reflectionSampler;
		uniform sampler2D bumpSampler;		 
		void main(void) {
			vec3 viewDirectionW = normalize(vEyePosition - vPositionW);
		 
			// Light
			vec3 lightVectorW = normalize(vLightPosition - vPositionW);
		 
			// Wave
			vec3 bumpNormal = 2.0 * texture2D(bumpSampler, vBumpUV).rgb - 1.0;
			vec2 perturbation = waveData.y * bumpNormal.rg;
		 
			// diffuse
			float ndl = max(0., dot(vNormalW, lightVectorW));
		 
			// Specular
			vec3 angleW = normalize(viewDirectionW + lightVectorW);
			float specComp = dot(normalize(vNormalW), angleW);
			specComp = pow(specComp, 256.);
		 
			// Refraction
			vec2 texCoords;
			texCoords.x = vUV.x / vUV.w / 2.0 + 0.5;
			texCoords.y = vUV.y / vUV.w / 2.0 + 0.5;
		 
			vec3 refractionColor = texture2D(refractionSampler, texCoords + perturbation).rgb;
		 
			// Reflection
			vec3 reflectionColor = texture2D(reflectionSampler, texCoords + perturbation).rgb;
		 
			// Fresnel
			float fresnelTerm = dot(viewDirectionW, vNormalW);
			fresnelTerm = clamp((1.0 - fresnelTerm) * vLevels.y, 0., 1.);
		 
			// Water color
		 
			vec3 finalColor = (waterColor * ndl) * vLevels.x + (1.0 - vLevels.x) * (reflectionColor * fresnelTerm * vLevels.z + 
															   (1.0 - fresnelTerm) * refractionColor * vLevels.w) + specComp;
		 
			gl_FragColor = vec4(finalColor, 1.);
		}
		</script>
		<script src="Water/waterMaterial.js"></script>
        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true);
		
		
        var createScene = function () {
            var scene = new BABYLON.Scene(engine);
			//scene.clearColor = new BABYLON.Color3(0.5, 0.8, 0.5);
			//scene.ambientColor = new BABYLON.Color3(0.3, 0.3, 0.3);
            //Create a light
            //var light = new BABYLON.DirectionalLight("dir01", new BABYLON.Vector3(0.5, -1, -0.5), scene);
        	var  light = new BABYLON.PointLight("dir01", new BABYLON.Vector3(60, 100, 10), scene);
            //Create an Arc Rotate Camera - aimed negative z this time
            var camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(125, 1, 125), scene);
            camera.attachControl(canvas, true);
        
           
        
            //Ground
            var plane = BABYLON.Mesh.CreateGround("plane", 1000, 1000, 1, scene, false);
            plane.position.y = -6;
            //Creation of a repeated textured material
            var materialPlane = new BABYLON.StandardMaterial("texturePlane", scene);
            materialPlane.diffuseTexture = new BABYLON.Texture("textures/grass.jpg", scene);
            materialPlane.diffuseTexture.uScale = 50.0;//Repeat 50 times on the Vertical Axes
            materialPlane.diffuseTexture.vScale = 50.0;//Repeat 50 times on the Horizontal Axes
            //materialPlane.backFaceCulling = false;//Always show the front and the back of an element
			//plane.renderingGroupId = 1;
			plane.material = materialPlane;
			
            //Sky&Fog
            var skybox = BABYLON.Mesh.CreateBox("skyBox", 500.0, scene);
			var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
			skyboxMaterial.backFaceCulling = false;
			skyboxMaterial.disableLighting = true;
			skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
			skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
			skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
			skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
			skybox.material = skyboxMaterial;
			skybox.infiniteDistance = true;
			//skybox.renderingGroupId = 0;
			scene.registerBeforeRender(function () {
				skybox.rotation.y += 0.0001;	
				if(camera.position.y <0) camera.position.y =0;
				//if(camera.position.y >0) camera.position.y =0;
				});
			//scene.fogMode = BABYLON.Scene.FOGMODE_EXP;
			//scene.fogDensity = 0.004;
			//scene.fogColor = new BABYLON.Color3(0.9, 0.9, 0.85);
			 // water shading
			BABYLON.Engine.ShadersRepository="";
			var water = BABYLON.Mesh.CreateGround("water", 34, 38, 1, scene, false);	
			var waterMaterial = new WaterMaterial("water", scene, light);			 
			  water.position.x=125;
			  water.position.z=125;
			   water.position.y=4.75-3;
			
			 //-----------
			//---------Loading Object
			  BABYLON.SceneLoader.ImportMesh("", "", "dogoo2.babylon", scene, function (newMeshes) {
			// Set the target of the camera to the first imported mesh
			newMeshes[0].position.z=0;
			 newMeshes[0].position.y=-5;
			 //newMeshes[0].renderingGroupId = 2;
				});		
			  BABYLON.SceneLoader.ImportMesh("", "", "dogoo.babylon", scene, function (newMeshes) {
			// Set the target of the camera to the first imported mesh
			newMeshes[0].position.x=20;
			newMeshes[0].position.z=0;
			 newMeshes[0].position.y=-5;
			// newMeshes[0].renderingGroupId = 2;
				});	
					BABYLON.SceneLoader.ImportMesh("", "", "dogoo3.babylon", scene, function (newMeshes) {
			// Set the target of the camera to the first imported mesh
			  waterMaterial.reflectionTexture.renderList.push(newMeshes[0]);
			newMeshes[0].position.x=125;
			newMeshes[0].position.z=125;
			 newMeshes[0].position.y=10;
			 //newMeshes[0].renderingGroupId = 2;
				});		
			waterMaterial.reflectionTexture.renderList.push(skybox);	
			var pool = BABYLON.SceneLoader.ImportMesh("", "", "pool.babylon", scene, function (newMeshes) {
			// Set the target of the camera to the first imported mesh
			  waterMaterial.reflectionTexture.renderList.push(newMeshes[0]);
			  newMeshes[0].position.x=100;
			  newMeshes[0].position.z=100;
			  newMeshes[0].position.y=0-3;
			 // newMeshes[0].renderingGroupId = 2;
				});		
			waterMaterial.reflectionTexture.renderList.push(plane);				
			waterMaterial.reflectionTexture.renderList.push(skybox);		
			water.material = waterMaterial;
            return scene;
        };
        
        
        var scene = createScene();

        engine.runRenderLoop(function () {
            scene.render();
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>
</html>
